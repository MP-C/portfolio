<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <title>Opera√ß√£o Regresso üè†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #f0f4f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero { background: linear-gradient(135deg, #003366, #00509d); color: white; padding: 50px 0; text-align: center; border-bottom: 5px solid #ffca28; }
        .avatar-3d { font-size: 4rem; display: block; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); transition: 0.3s; cursor: pointer; user-select: none; }
        .avatar-3d:active { transform: scale(0.9); }
        .card-pessoa { border-radius: 20px; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.05); transition: 0.3s; }
        .card-pessoa:hover { transform: translateY(-5px); }
        .voto-item { background: white; margin-bottom: 5px; padding: 10px; border-radius: 10px; border-left: 5px solid #00509d; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .bubble { background: #e9ecef; padding: 10px; border-radius: 15px; min-height: 60px; display: flex; align-items: center; justify-content: center; font-style: italic; }
        .countdown-section { background: #fff; border-radius: 20px; padding: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 2px solid #00509d; }
        #timer { font-size: 2.5rem; font-weight: bold; color: #00509d; }
        .winner-box { display: none; background: #ffca28; color: #003366; padding: 20px; border-radius: 15px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="hero mb-5">
    <h1>üìç Opera√ß√£o Regresso 2026</h1>
    <p class="lead">A contagem decrescente para o nosso regresso a casa!</p>
</div>

<div class="container">
    <div class="row text-center mb-5">
        <div class="col-md-4 mb-3">
            <div class="card card-pessoa p-4 h-100">
                <span class="avatar-3d" onclick="mudarFrase('mario')">üßîüèª‚Äç‚ôÇÔ∏è</span>
                <h3 class="mt-3">M√°rio</h3>
                <div class="bubble mb-3"><p id="frase-mario" class="small m-0">"J√° estou a embalar a cave."</p></div>
                <div class="badge bg-primary">A preparar os servidores</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card card-pessoa p-4 h-100">
                <span class="avatar-3d" onclick="mudarFrase('joana')">üë©üèª</span>
                <h3 class="mt-3">Joana</h3>
                <div class="bubble mb-3"><p id="frase-joana" class="small m-0">"Ansiedade n√≠vel 99, log√≠stica n√≠vel 100."</p></div>
                <div class="badge bg-danger">Mestre das Malas</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card card-pessoa p-4 h-100">
                <span class="avatar-3d" onclick="mudarFrase('lourenco')">üë∂üèª</span>
                <h3 class="mt-3">Louren√ßo</h3>
                <div class="bubble mb-3"><p id="frase-lourenco" class="small m-0">"S√≥ quero saber se os brinquedos cabem todos."</p></div>
                <div class="badge bg-success">Chefe da Divers√£o</div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-md-6 mb-4">
            <div id="container-voto" class="p-4 bg-white shadow rounded-4 text-center">
                <div class="alert alert-warning fw-bold mb-4" style="border-radius: 15px; border: 2px dashed #ffca28;">
                    üéÅ Quem acertar no dia exato ganha o primeiro jantar de luxo (em casa)! üçïüç∑
                </div>
                <h4>üìÖ Quando chegamos?</h4>
                <input type="text" id="nome" class="form-control mb-2" placeholder="Teu Nome">
                <input type="date" id="data" class="form-control mb-3" min="2026-01-01" max="2026-12-31">
                <button id="btnVotar" onclick="votar()" class="btn btn-primary w-100 fw-bold">Submeter Aposta!</button>
            </div>
        </div>

        <div class="col-md-6">
            <div class="p-4 bg-light border rounded-4 h-100">
                <h4>üìä Apostas efetuadas:</h4>
                <div id="lista-votos" class="mt-3">
                    <p class="text-muted small">A carregar...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5 justify-content-center text-center">
        <div class="col-md-8">
            <div class="countdown-section">
                <h4 id="countdown-title">‚è≥ Tempo restante para o regresso:</h4>
                <div id="timer" class="my-3">00d 00h 00m 00s</div>
                
                <div id="winner-zone" class="winner-box">
                    <h3>üèÜ VENCEDOR(A) DO JANTAR üèÜ</h3>
                    <h2 id="winner-name" class="fw-bold">...</h2>
                    <p class="m-0">Parab√©ns! Acertaste na mosca!</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center pb-5 opacity-50">
        <p>¬© 2026 Opera√ß√£o Regresso | Feito com ‚ù§Ô∏è</p>
    </footer>
</div>

<script>
    // URL DEFINITIVO (Certifica-te que termina em /exec)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwAOSRYjlMJKS1HfBOeR0GNjDFNANQlN9f-gh0-7bWkKEmcN_bN7hdu5yTKAXhx9ugyFA/exec";
    const diaChegada = "2026-05-31"; // DATA ALVO PARA O VENCEDOR

    // --- FRASES DIVERTIDAS ---
    const frases = {
        mario: ["J√° vou ter de embalar a cave..psss", "Vou precisar de uma carrinha s√≥ para os gadgets.", "Docker pronto para a migra√ß√£o f√≠sica.", "Saudades de um pastel de nata!", "O que fazemos a isto? Guarda-se?"],
        joana: ["A controlar a log√≠stica e a ansiedade.", "Estava dif√≠cil convencer o M√°rio!", "Se n√£o usas h√° mais de um ano, d√°!", "Vou chegar e ir direta para a praia!", "Faltam 3 mil abra√ßos de despedida."],
        lourenco: ["S√≥ quero saber dos brinquedos!", "O avi√£o tem Wi-Fi para o Panda?", "Vou andar no colo de muita gente!", "Preparem as bochechas!", "Gugu dada?"]
    };
    let indices = { mario: 0, joana: 0, lourenco: 0 };
    function mudarFrase(p) {
        indices[p] = (indices[p] + 1) % frases[p].length;
        document.getElementById(`frase-${p}`).innerText = `"${frases[p][indices[p]]}"`;
    }

    // --- BLOQUEIO DE VOTO DUPLO (INTERFACE) ---
    function bloquearFormulario() {
        const btn = document.getElementById("btnVotar");
        const nomeIn = document.getElementById("nome");
        const dataIn = document.getElementById("data");
        if(btn) {
            btn.disabled = true;
            btn.innerText = "Aposta Registada! üòâ";
            btn.className = "btn btn-secondary w-100 fw-bold";
        }
        if(nomeIn) nomeIn.disabled = true;
        if(dataIn) dataIn.disabled = true;
    }

    // --- LOGICA DE VOTAR ---
    function votar() {
        const nome = document.getElementById('nome').value.trim();
        const data = document.getElementById('data').value;

        if(!nome || !data) return alert("Por favor, preenche o nome e a data!");
        if(localStorage.getItem('ja_votei')) return alert("J√° apostaste! Agora √© s√≥ esperar.");

        const btn = document.getElementById("btnVotar");
        btn.disabled = true;
        btn.innerText = "A enviar para o Google...";

        const script = document.createElement('script');
        script.src = `${SCRIPT_URL}?nome=${encodeURIComponent(nome)}&data=${encodeURIComponent(data)}&callback=confirmarVoto`;
        document.body.appendChild(script);
    }

    window.confirmarVoto = function(res) {
        if (res.result === "already_voted") {
            alert("Este nome j√° foi usado numa aposta! Tenta usar um nome mais espec√≠fico.");
            const btn = document.getElementById("btnVotar");
            btn.disabled = false;
            btn.innerText = "Submeter Aposta!";
        } else {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            localStorage.setItem('ja_votei', 'true');
            bloquearFormulario();
            alert("üéâ Aposta guardada! Boa sorte!");
            location.reload();
        }
    };

    // --- LOGICA DE RENDERIZAR VOTOS ---
    function renderizarVotos() {
        const script = document.createElement('script');
        script.src = `${SCRIPT_URL}?callback=processarDados&t=${Date.now()}`;
        document.body.appendChild(script);
    }

    window.processarDados = function(dados) {
        const lista = document.getElementById('lista-votos');
        if (!dados || !Array.isArray(dados) || dados.length === 0) {
            lista.innerHTML = '<p class="text-muted small">Ainda ningu√©m apostou. S√™ o primeiro!</p>';
            return;
        }

        // Limpar e formatar datas (Google Sheets √†s vezes envia ISO strings)
        const formatados = dados.map(v => {
            let dStr = v[1] ? v[1].toString() : "";
            if (dStr.includes("T")) dStr = dStr.split("T")[0];
            return [v[0], dStr];
        });

        // Identificar Vencedores
        window.vencedoresData = formatados.filter(v => v[1] === diaChegada).map(v => v[0]);

        // Ordenar por data mais pr√≥xima
        formatados.sort((a, b) => new Date(a[1]) - new Date(b[1]));

        lista.innerHTML = formatados.map(v => `
            <div class="voto-item d-flex justify-content-between align-items-center">
                <strong>${v[0]}</strong>
                <span class="badge bg-dark">${v[1]}</span>
            </div>
        `).join('');
    };

    // --- CONTADOR DE TEMPO ---
    function updateCountdown() {
        const targetDate = new Date("May 31, 2026 00:00:00").getTime();
        const now = new Date().getTime();
        const distance = targetDate - now;

        if (distance < 0) {
            document.getElementById("countdown-title").innerHTML = "‚úàÔ∏è A OPERA√á√ÉO REGRESSO FOI UM SUCESSO!";
            document.getElementById("timer").style.display = "none";
            const zone = document.getElementById("winner-zone");
            zone.style.display = "block";
            document.getElementById("winner-name").innerText = 
                (window.vencedoresData && window.vencedoresData.length > 0) 
                ? window.vencedoresData.join(", ") 
                : "Ningu√©m acertou no dia!";
            return;
        }

        const d = Math.floor(distance / (1000 * 60 * 60 * 24));
        const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((distance % (1000 * 60)) / 1000);

        document.getElementById("timer").innerHTML = `${d}d ${h}h ${m}m ${s}s`;
    }

    // IN√çCIO AO CARREGAR
    window.onload = () => {
        if (localStorage.getItem('ja_votei')) bloquearFormulario();
        renderizarVotos();
        setInterval(updateCountdown, 1000);
        updateCountdown();
    };
</script>

</body>
</html>